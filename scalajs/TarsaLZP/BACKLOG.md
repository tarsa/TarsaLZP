TODO:
- write tests
- simplify code
- improve type soundness